version: '3.8'

services:
  # Scheduler - Sincronização automática a cada 10 minutos
  scheduler:
    build:
      context: .
      args:
        MODE: scheduler
    container_name: auvo-vtiger-scheduler
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Database
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_INTEGRATION_URL=${DATABASE_INTEGRATION_URL}
      # CRM
      - CRM_URL=${CRM_URL}
      - CRM_USERNAME=${CRM_USERNAME}
      - CRM_PASSWORD=${CRM_PASSWORD}
      # Auvo API
      - AUVO_API_KEY=${AUVO_API_KEY}
      - AUVO_API_TOKEN=${AUVO_API_TOKEN}
      - AUVO_API_URL=${AUVO_API_URL:-https://api.auvo.com.br/v2}
      # Google Maps
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
      # Email
      - ERROR_EMAIL_TO=${ERROR_EMAIL_TO}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_SECURE=${SMTP_SECURE:-true}
      # Filters
      - ENABLE_PILOT_FILTER=${ENABLE_PILOT_FILTER:-false}
      - PILOT_USER_IDS=${PILOT_USER_IDS:-}
      - ENABLE_GEOCODING_FILTER=${ENABLE_GEOCODING_FILTER:-false}
      - GEOCODING_USER_IDS=${GEOCODING_USER_IDS:-}
      # Scheduler
      - SYNC_CRON_EXPRESSION=${SYNC_CRON_EXPRESSION:-*/10 * * * *}
      - SYNC_RUN_IMMEDIATELY=${SYNC_RUN_IMMEDIATELY:-false}
      # DLQ Auto Reprocess
      - DLQ_ENABLED=${DLQ_ENABLED:-true}
      - DLQ_CRON_EXPRESSION=${DLQ_CRON_EXPRESSION:-0 23 * * *}
      - DLQ_MAX_RETRIES=${DLQ_MAX_RETRIES:-3}
    volumes:
      - ./logs:/app/logs
    networks:
      - network_public

  # API - Servidor para webhooks, Admin Panel e DLQ
  api:
    build:
      context: .
      args:
        MODE: api
    container_name: auvo-vtiger-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - API_BASE_URL=${API_BASE_URL:-https://apicrm.purifikar.com.br}
      # Database
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_INTEGRATION_URL=${DATABASE_INTEGRATION_URL}
      # CRM
      - CRM_URL=${CRM_URL}
      - CRM_USERNAME=${CRM_USERNAME}
      - CRM_PASSWORD=${CRM_PASSWORD}
      # Email
      - ERROR_EMAIL_TO=${ERROR_EMAIL_TO}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_SECURE=${SMTP_SECURE:-true}
    volumes:
      - ./logs:/app/logs
    networks:
      - network_public
    labels:
      - traefik.enable=true
      - traefik.http.routers.auvo-api.rule=Host(`apicrm.purifikar.com.br`)
      - traefik.http.routers.auvo-api.entrypoints=websecure
      - traefik.http.routers.auvo-api.tls.certresolver=myresolver
      - traefik.http.services.auvo-api.loadbalancer.server.port=3000
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  network_public:
    external: true
